name: Reusable Deploy (SoEasy)

on:
  workflow_call:
    inputs:
      build_cmd:
        required: true
        type: string
      deploy_path:
        required: true
        type: string
    secrets:
      SSH_PRIVATE_KEY:
        required: true
      SSH_HOST:
        required: true
      SSH_PORT:
        required: true
      SSH_USER:
        required: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install deploy tools
        shell: bash
        run: |
          set -euxo pipefail
          sudo apt-get update
          sudo apt-get install -y rsync openssh-client

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install & build
        shell: bash
        run: |
          set -euxo pipefail
          bash -c "${{ inputs.build_cmd }}"

      - name: Decide build output folder
        id: out
        shell: bash
        run: |
          set -euxo pipefail
          if [ -d "dist" ]; then
            echo "dir=dist" >> "$GITHUB_OUTPUT"
          elif [ -d "build" ]; then
            echo "dir=build" >> "$GITHUB_OUTPUT"
          elif [ -d "out" ]; then
            echo "dir=out" >> "$GITHUB_OUTPUT"
          else
            echo "ERROR: No dist/ build/ or out/ found after build"
            ls -la
            exit 1
          fi

      - name: Setup SSH (key + clean vars)
        shell: bash
        run: |
          set -euxo pipefail
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          # Key (verbatim)
          printf '%s\n' "${{ secrets.SSH_PRIVATE_KEY }}" | tr -d '\r' > ~/.ssh/id_rsa

          chmod 600 ~/.ssh/id_rsa
          ssh-keygen -y -f ~/.ssh/id_rsa > /dev/null

          # Clean secrets (kill CR/LF + trim)
          SSH_PORT_CLEAN="$(printf '%s' '${{ secrets.SSH_PORT }}' | tr -d '\r\n' | xargs)"
          SSH_USER_CLEAN="$(printf '%s' '${{ secrets.SSH_USER }}' | tr -d '\r\n' | xargs)"
          SSH_HOST_CLEAN="$(printf '%s' '${{ secrets.SSH_HOST }}' | tr -d '\r\n' | xargs)"

          {
            echo "SSH_PORT_CLEAN=$SSH_PORT_CLEAN"
            echo "SSH_USER_CLEAN=$SSH_USER_CLEAN"
            echo "SSH_HOST_CLEAN=$SSH_HOST_CLEAN"
            echo "SSH_TARGET=$SSH_USER_CLEAN@$SSH_HOST_CLEAN"
          } >> "$GITHUB_ENV"

      - name: Check SSH connectivity (non-interactive)
        shell: bash
        run: |
          set -euxo pipefail
          ssh \
            -i ~/.ssh/id_rsa \
            -p "$SSH_PORT_CLEAN" \
            -o StrictHostKeyChecking=accept-new \
            -o UserKnownHostsFile=/dev/null \
            -o ConnectTimeout=10 \
            "$SSH_TARGET" 'echo OK'

      - name: Ensure deploy path exists (server)
        shell: bash
        run: |
          set -euxo pipefail
          ssh \
            -i ~/.ssh/id_rsa \
            -p "$SSH_PORT_CLEAN" \
            -o StrictHostKeyChecking=accept-new \
            -o UserKnownHostsFile=/dev/null \
            "$SSH_TARGET" \
            "mkdir -p '${{ inputs.deploy_path }}'"

      - name: Deploy via rsync (build output only)
        shell: bash
        run: |
          set -euxo pipefail
          SRC_DIR="${{ steps.out.outputs.dir }}"
          echo "Deploying folder: $SRC_DIR/ -> ${{ inputs.deploy_path }}/"

          # Build ssh args as an array to avoid broken -o strings
          SSH_ARGS=(
            -i "$HOME/.ssh/id_rsa"
            -p "$SSH_PORT_CLEAN"
            -o StrictHostKeyChecking=accept-new
            -o UserKnownHostsFile=/dev/null
          )

          rsync -avz --delete \
            -e "ssh ${SSH_ARGS[*]}" \
            "$SRC_DIR"/ \
            "$SSH_TARGET:${{ inputs.deploy_path }}/"
